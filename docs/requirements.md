# 要件定義書

## プロジェクト概要

### プロジェクト名
Excalidraw カスタムキーボードショートカット & ファイル操作システム

### 目的
Excalidrawにカスタムキーボードショートカット、付箋機能、ローカルファイル操作機能を追加し、生産性を向上させる統合的な描画ツールを提供する。

### 対象ユーザー
- ドキュメント作成者
- 開発者
- デザイナー
- プロジェクトマネージャー

## 機能要件

### 1. キーボードショートカット機能

#### 1.1 図形作成ショートカット
- **要件ID**: REQ-001
- **機能**: 矢印なし直線作成
- **操作**: `C`キー押下
- **動作**: 矢印ツールを選択し、矢印ヘッドを無効化した直線を描画可能にする

#### 1.2 付箋作成ショートカット
- **要件ID**: REQ-002
- **機能**: 基本付箋作成
- **操作**: `N`キー押下
- **動作**: マウス位置に黄色背景の付箋を作成

- **要件ID**: REQ-003
- **機能**: クリップボード付箋作成
- **操作**: `W`キー押下
- **動作**: クリップボードの内容を読み取り、適切な形式で付箋を作成

#### 1.3 レイヤー操作ショートカット
- **要件ID**: REQ-004
- **機能**: 最前面移動
- **操作**: `Cmd/Ctrl + M`キー押下
- **動作**: 選択した要素を最前面に移動

- **要件ID**: REQ-005
- **機能**: 最背面移動
- **操作**: `Cmd/Ctrl + B`キー押下
- **動作**: 選択した要素を最背面に移動

### 2. ファイル操作機能

#### 2.1 ファイル読み込み
- **要件ID**: REQ-006
- **機能**: URLパラメータによるファイル指定
- **操作**: `?filepath=/path/to/file.excalidraw`
- **動作**: 指定されたローカルファイルを読み込み、Excalidrawに表示

#### 2.2 自動保存
- **要件ID**: REQ-007
- **機能**: オブジェクト変更時の自動保存
- **動作**: 
  - オブジェクトに変更があった場合のみ保存
  - ポインタの移動では保存されない
  - 標準Excalidrawファイル形式で保存

#### 2.3 外部編集対応
- **要件ID**: REQ-008
- **機能**: 外部エディタとの連携
- **動作**: 
  - 5秒間隔でファイルの更新日時をチェック
  - 外部で編集された場合は自動的にリロード
  - VSCodeのExcalidraw拡張との互換性

### 3. バックアップ機能

#### 3.1 自動バックアップ
- **要件ID**: REQ-009
- **機能**: 定期的な自動バックアップ
- **動作**: 
  - 最新バックアップから5分以上経過した場合にバックアップ作成
  - 元ファイルと同じディレクトリの`backup/`フォルダに保存
  - ファイル名: `{元ファイル名}_backup_{00-09}.excalidraw`

#### 3.2 バックアップローテーション
- **要件ID**: REQ-010
- **機能**: バックアップファイルの管理
- **動作**: 
  - 最大10個のバックアップを保持
  - 10個を超えた場合は古いものから上書き
  - バックアップ失敗時も元ファイルの保存は継続

## 非機能要件

### 性能要件
- **要件ID**: NFR-001
- **内容**: キーボードショートカットの応答時間は100ms以内
- **要件ID**: NFR-002
- **内容**: ファイル読み込み時間は2秒以内（10MB以下のファイル）
- **要件ID**: NFR-003
- **内容**: 自動保存の処理時間は1秒以内

### オフライン要件
- **要件ID**: NFR-004
- **内容**: ビルド後は完全オフライン実行が可能
- **要件ID**: NFR-005
- **内容**: 静的ファイルのみで基本描画機能が動作
- **要件ID**: NFR-006
- **内容**: オフライン時もキーボードショートカットと付箋機能が利用可能

### 可用性要件
- **要件ID**: NFR-007
- **内容**: バックエンドサーバーの稼働率99%以上
- **要件ID**: NFR-008
- **内容**: バックアップ作成失敗時も元機能の継続動作

### セキュリティ要件
- **要件ID**: NFR-009
- **内容**: ローカルファイルアクセスのみ許可（外部サーバーアクセス不可）
- **要件ID**: NFR-010
- **内容**: クリップボードアクセスはHTTPS/localhost環境でのみ動作

### 互換性要件
- **要件ID**: NFR-011
- **内容**: VSCodeのExcalidraw拡張との完全互換性
- **要件ID**: NFR-012
- **内容**: 標準Excalidrawファイル形式の完全サポート

## 技術要件

### フロントエンド
- React 19.0.0以上
- TypeScript 5.0以上
- Vite 5.0以上
- @excalidraw/excalidraw最新版

### バックエンド
- Python 3.8以上
- FastAPI 0.68以上
- Uvicorn

### 環境要件
- Node.js 18.0以上
- モダンブラウザ（Chrome, Firefox, Safari, Edge）
- ローカル開発環境

## 制約事項

### 技術的制約
- ブラウザのセキュリティ制限によりローカルファイルアクセスにはバックエンドサーバーが必要
- クリップボードAPIはHTTPS環境またはlocalhost環境でのみ動作
- ファイル監視機能は5秒間隔での定期チェック方式
- オフライン時はURLパラメータファイル読み込み不可

### 運用制約
- バックアップファイルは手動削除が必要
- 大容量ファイル（10MB以上）は動作保証外
- 同時編集機能は非対応
- オフライン時は自動バックアップ機能不可

## 今後の拡張計画

### Phase 2 機能
- バックアップファイルの復元UI
- カスタムショートカットの設定UI
- 付箋テンプレート機能

### Phase 3 機能
- ドラッグ&ドロップ機能
- メール付箋機能の完全実装

### Phase 4 機能
- パフォーマンス最適化
- 大容量ファイル対応

## 受け入れ基準

### 機能テスト
- 全キーボードショートカットが正常に動作する
- ファイル読み込み・保存が正常に動作する
- バックアップ機能が仕様通りに動作する
- 外部編集の自動リロードが正常に動作する

### 性能テスト
- 応答時間が要件を満たす
- メモリ使用量が適切な範囲内
- 長時間使用時の安定性

### 互換性テスト
- VSCodeのExcalidraw拡張で作成したファイルが正常に読み込める
- 本システムで作成したファイルがVSCodeで正常に開ける
- 標準Excalidrawファイル形式との完全互換性

## リスク分析

### 技術リスク
- **リスク**: Excalidrawのバージョンアップによる互換性問題
- **対策**: 定期的なバージョン確認と適合性テスト

### 運用リスク
- **リスク**: バックアップファイルの蓄積によるディスク容量不足
- **対策**: 定期的なバックアップファイルの整理推奨

### セキュリティリスク
- **リスク**: ローカルファイルアクセスによる情報漏洩
- **対策**: ファイルアクセス権限の適切な設定