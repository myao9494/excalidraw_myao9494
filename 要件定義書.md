# 要件定義書

## 1. プロジェクト概要

**目的**: `excalidraw_latest.html`に実装された独自機能を現在のExcalidrawリポジトリに移植する

**現在の状況**:
- 現在のリポジトリ: React + TypeScript + Vite環境でExcalidrawを使用
- 移植元: Flask + CDN版Excalidrawを使用したHTMLファイル

## 2. 移植対象機能

### 2.1 カスタムキーボードショートカット
| キー | 機能 | 実装優先度 |
|-----|------|----------|
| `C` | 矢印なしの直線描画 | 高 |
| `N` | 付箋メモ作成 | 高 |
| `W` | クリップボードからリンク付き付箋作成 | 高 |
| `Cmd/Ctrl + M` | 選択要素を最前面に移動 | 中 |
| `Cmd/Ctrl + B` | 選択要素を最背面に移動 | 中 |

### 2.2 ドラッグ&ドロップ機能
| 対象 | 動作 | 実装優先度 |
|------|------|----------|
| 画像ファイル | 直接キャンバスに配置 | 高 |
| 一般ファイル | 付箋として追加 | 高 |
| メールファイル(.eml/.msg) | 特別な青色付箋として追加 | 高 |
| フォルダ | ショートカット付箋として追加 | 高 |
| Outlookメール | 直接ドラッグ対応 | 高 |

### 2.3 付箋機能
- **基本付箋**: 黄色背景 (`#fef3bd`)
- **メール付箋**: 青色背景 (`#e3f2fd`)
- **リンク付箋**: ファイルパス埋め込み機能
- **自動テキスト設定**: ファイル名またはカスタムテキスト


## 3. 技術的制約・考慮事項

### 3.1 環境差異
- **移植元**: Flask + CDN (esm.sh)
- **移植先**: React + TypeScript + Vite + npm packages


## 4. 実装方針

### 4.1 段階的実装
1. **フェーズ1**: 基本的なキーボードショートカット（C, N, W）
2. **フェーズ2**: レイヤー操作（Cmd+M, Cmd+B）
3. **フェーズ3**: 画像ドラッグ&ドロップ

### 4.2 実装場所

できるだけ1つのファイルが肥大化しないように、ファイルを分散してください

- メインコンポーネント: `components/ExampleApp.tsx`
- キーボードハンドラー: `useEffect`内で実装
- ドラッグ&ドロップ: 独立したカスタムフック作成を検討

### 4.3 設計原則
- 既存コードへの影響を最小限に抑制
- TypeScriptの型安全性を維持
- Excalidraw公式APIの使用を優先
- コメントは日本語でつけること
- ドキュメントを同時に作成すること

## 5. 実装詳細

### 5.1 移植元HTMLファイルの主要機能分析

#### キーボードショートカット実装
- **Cキー**: 矢印ツールを選択後、矢印の開始・終了をnullに設定
- **Nキー**: マウス位置に黄色の付箋（rectangle + text）を作成
- **Wキー**: クリップボードからテキストを取得し、リンク付き付箋を作成
- **Cmd/Ctrl + M**: 選択要素を配列の末尾に移動（最前面）
- **Cmd/Ctrl + B**: 選択要素を配列の先頭に移動（最背面）

#### ドラッグ&ドロップ機能
- キャプチャフェーズでのイベント処理
- 画像ファイルの自動リサイズ（最大400px）
- ファイル種別による付箋色の変更
- Outlookメールの特別処理

#### 付箋作成機能
- rectangle要素とtext要素をバインド
- 座標の正規化処理
- 自動フォーカス設定

### 5.2 技術的実装ポイント

#### 座標計算
```javascript
// ズーム倍率を考慮した座標計算
const zoom = excalidrawAPI.getAppState().zoom.value;
const viewportPosition = {
    x: (excalidrawAPI.getAppState().scrollX * -1) + mouseX / zoom,
    y: (excalidrawAPI.getAppState().scrollY * -1) + mouseY / zoom
};
```

#### 要素作成テンプレート
```javascript
const rectangleElement = {
    id: Math.random().toString(36).substr(2, 9),
    type: 'rectangle',
    x: x - 100,
    y: y - 25,
    width: 200,
    height: 50,
    backgroundColor: '#fef3bd',
    // その他のプロパティ...
};
```

### 5.3 React環境での実装調整点

#### 1. マウス座標取得
- HTMLファイル: グローバルなmousemoveイベント
- React環境: useRefとuseEffectでのイベント管理

#### 2. クリップボードAPI
- 現代的なNavigator Clipboard APIの使用
- 非同期処理での適切なエラーハンドリング

#### 3. TypeScript対応
- Excalidraw要素の型定義
- イベントハンドラーの型安全性


## 6. 成功基準

### 必須項目
- [ ] Cキーで矢印なし直線が描画できる
- [ ] Nキーで付箋メモが作成できる
- [ ] Wキーでクリップボードから付箋が作成できる
- [ ] 既存のExcalidraw機能に影響を与えない

### 推奨項目
- [ ] Cmd/Ctrl + M/Bでレイヤー操作ができる
- [ ] 画像ファイルをドラッグ&ドロップで配置できる
- [ ] TypeScriptの型安全性が維持されている
- [ ] パフォーマンスが劣化しない

